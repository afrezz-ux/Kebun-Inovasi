<script>
    // --- CONFIG ---
    const ONGKIR_JEMBER = 10000;
    const ONGKIR_LUAR = 30000;
    const ADMIN_WA_NUMBER = '6281515524727';

    // DATABASE PRODUK (TIDAK ADA LOCALSTORAGE)
    const fallbackDB = [
        { id: 'p1', name: "Jeruk Siam", category: "Buah", price: 12000, unit: "/kg", stock: 50, img: "images/jeruk1.jpg", desc: "Jeruk Siam segar." },
        { id: 'p2', name: "Mangga Harum Manis", category: "Buah", price: 30000, unit: "/kg", stock: 30, img: "images/mangga.jpg", desc: "Mangga premium." },
        { id: 'p3', name: "Nanas Madu", category: "Buah", price: 18000, unit: "/buah", stock: 40, img: "images/nanas.jpg", desc: "Nanas super manis." },
        { id: 'p4', name: "Jeruk Pamelo", category: "Buah", price: 15000, unit: "/kg", stock: 25, img: "images/jerukpamelo.jpg", desc: "Jeruk segar." },
        { id: 'p5', name: "Semangka", category: "Buah", price: 25000, unit: "/kg", stock: 15, img: "images/semangka.png", desc: "Semangka manis." },

        { id: 't1', name: "Tabulampot Jambu", category: "Tabulampot", price: 250000, unit: "/pot", stock: 5, img: "images/tabulampotjeruk.jpg", desc: "Bibit siap berbuah." },
        { id: 't2', name: "Tabulampot Jeruk", category: "Tabulampot", price: 275000, unit: "/pot", stock: 3, img: "images/tabulampotmangga.jpg", desc: "Jeruk Jepang premium." },
        { id: 't3', name: "Tabulampot Nanas", category: "Tabulampot", price: 300000, unit: "/pot", stock: 4, img: "images/tabulampotnanas.png", desc: "Nanas siap panen." }
    ];

    let product = null;
    let qty = 1;
    let shippingCost = 0;

    const fmtMoney = (n) => `Rp ${new Intl.NumberFormat('id-ID').format(n)}`;
    const formatPriceWA = (n) => new Intl.NumberFormat('id-ID').format(n);

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const pId = params.get('id');
        qty = parseInt(params.get('qty')) || 1;

        // CARI PRODUK LANGSUNG DARI fallbackDB
        product = fallbackDB.find(p => p.id === pId);

        if (!product) {
            alert("Produk tidak ditemukan!");
            window.location.href = "produk.html";
            return;
        }

        renderUI();
    });

    function renderUI() {
        document.getElementById('p_img').src = product.img;
        document.getElementById('p_name').innerText = product.name;
        document.getElementById('p_qty_display').innerText = `Jumlah: ${qty} ${product.unit.replace('/', '')}`;
        document.getElementById('p_price').innerText = fmtMoney(product.price) + product.unit;

        calculate();
    }

    function calculate() {
        const subtotal = product.price * qty;
        const total = subtotal + shippingCost;

        document.getElementById('p_subtotal').innerText = fmtMoney(subtotal);
        document.getElementById('p_shipping').innerText = 
            shippingCost === 0 ? 'Dihitung' : fmtMoney(shippingCost);
        document.getElementById('p_total').innerText = fmtMoney(total);
    }

    // --- EVENT: AREA ---
    document.getElementById('area').addEventListener('change', function () {
        const val = this.value;
        const kabGroup = document.getElementById('kabupaten-group');

        if (val === 'JEMBER') {
            shippingCost = ONGKIR_JEMBER;
            kabGroup.style.display = 'none';
        } else if (val === 'LUAR_JEMBER') {
            shippingCost = ONGKIR_LUAR;
            kabGroup.style.display = 'block';
        } else {
            shippingCost = 0;
            kabGroup.style.display = 'none';
        }

        calculate();
    });

    // --- EVENT: SUBMIT FORM ---
    document.getElementById('checkoutForm').addEventListener('submit', function (e) {
        e.preventDefault();

        if (shippingCost === 0) {
            alert("Silakan pilih area pengiriman.");
            return;
        }

        const nama = document.getElementById('nama').value;
        const wa = document.getElementById('whatsapp').value;
        const area = document.getElementById('area').value;
        const alamat = document.getElementById('alamat').value;
        const kabupaten = document.getElementById('kabupaten').value || "-";
        const metode = document.querySelector('input[name="payment"]:checked').value;

        const subtotal = product.price * qty;
        const total = subtotal + shippingCost;

        // TAMPILKAN MODAL STRUK
        document.getElementById('r_id').innerText = "#INV-" + Date.now();
        document.getElementById('r_date').innerText = new Date().toLocaleString('id-ID');

        document.getElementById('r_nama').innerText = nama;
        document.getElementById('r_area').innerText = 
            area === "LUAR_JEMBER" ? kabupaten : "Jember";

        document.getElementById('r_prod_name').innerText = `${product.name} x${qty}`;
        document.getElementById('r_prod_price').innerText = fmtMoney(subtotal);
        document.getElementById('r_shipping').innerText = fmtMoney(shippingCost);
        document.getElementById('r_grand_total').innerText = fmtMoney(total);
        document.getElementById('r_method').innerText = metode;

        // LINK WHATSAPP
        const waText = 
            `*KONFIRMASI PESANAN BARU*\n\n` +
            `Nama: ${nama}\n` +
            `WA: ${wa}\n` +
            `Area: ${area === 'JEMBER' ? 'Jember' : kabupaten}\n` +
            `Alamat: ${alamat}\n\n` +
            `*Produk*: ${product.name}\n` +
            `Jumlah: ${qty} ${product.unit.replace("/", "")}\n` +
            `Harga: Rp ${formatPriceWA(product.price)}\n` +
            `Subtotal: Rp ${formatPriceWA(subtotal)}\n` +
            `Ongkir: Rp ${formatPriceWA(shippingCost)}\n\n` +
            `*Total Bayar: Rp ${formatPriceWA(total)}*\n\n` +
            `Metode: ${metode}`;

        document.getElementById('waBtn').href =
            `https://wa.me/${ADMIN_WA_NUMBER}?text=${encodeURIComponent(waText)}`;

        document.getElementById('receiptModal').style.display = "flex";
        setTimeout(() => {
            document.getElementById('receiptModal').classList.add('active');
        }, 10);
    });
</script>
